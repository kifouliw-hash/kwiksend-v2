<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KwikSend ‚Äî Relev√©s</title>
  <link rel="stylesheet" href="style.css">

  <!-- Librairies -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
</head>
<body>

<header>
  <div class="header-container">
    <div class="logo">Kwik<span>Send</span></div>
    <nav>
      <ul class="nav-links" id="nav-menu">
        <li><a href="dashboard.html">Accueil</a></li>
        <li><a href="portefeuille.html">Portefeuille</a></li>
        <li><a href="transfert.html">Transfert</a></li>
        <li><a href="kwiktransfert.html">KwikTransfert</a></li>
        <li><a href="releves.html">Relev√©s</a></li>
        <li><a href="profile.html">Compte</a></li>
        <li><a href="#" onclick="logout()">D√©connexion</a></li>
      </ul>
    </nav>
    <span class="burger" onclick="toggleMenu()">‚ò∞</span>
  </div>
</header>

<main style="max-width:1000px;margin:auto;padding:2rem;">
  <h1 style="text-align:center;margin-bottom:1rem;">üìÑ Relev√© de transactions</h1>

  <!-- Infos utilisateur -->
  <section style="background:white;padding:1rem 1.5rem;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.1);margin-bottom:1.5rem;">
    <p><b>Nom :</b> <span id="userName">KwikSend User</span></p>
    <p><b>Email :</b> <span id="userEmail">user@kwiksend.com</span></p>
    <p><b>P√©riode :</b> <span id="period">01/09/2025 ‚Äì 04/10/2025</span></p>
    <p><b>Devise principale :</b> EUR</p>
  </section>

  <!-- Filtres -->
  <section style="margin-bottom:1.5rem;display:flex;flex-wrap:wrap;gap:0.8rem;align-items:center;">
    <label>Du :</label><input type="date" id="startDate" />
    <label>au :</label><input type="date" id="endDate" />
    <button onclick="filterTransactions()">Appliquer</button>
    <button onclick="resetFilter()">R√©initialiser</button>
    <button onclick="downloadPDF()" style="margin-left:auto;">üßæ T√©l√©charger PDF</button>
  </section>

  <!-- Tableau transactions -->
  <div style="overflow-x:auto;">
    <table id="releveTableWrap" style="width:100%;border-collapse:collapse;background:white;border-radius:10px;overflow:hidden;">
      <thead style="background:var(--orange);color:white;">
        <tr>
          <th style="padding:10px;">Date</th>
          <th>Type</th>
          <th>Montant (‚Ç¨)</th>
          <th>Moyen</th>
          <th>De / √Ä</th>
          <th>Motif</th>
          <th>Statut</th>
        </tr>
      </thead>
      <tbody id="releveTable">
        <!-- Lignes remplies par JS -->
      </tbody>
    </table>
  </div>

  <p style="margin-top:1rem;font-size:0.9rem;color:#666;text-align:center;">
    Ce relev√© est g√©n√©r√© automatiquement par KwikSend ‚Äî Simulation √† titre indicatif.
  </p>
</main>

<footer style="text-align:center;padding:1rem;color:#777;">
  ¬© 2025 KwikSend ‚Äî Tous droits r√©serv√©s.
</footer>

<script>
/* ---------- Helpers storage ---------- */
const HIST_KEY = 'ks_history';
const HASH_STORE_KEY = 'ks_releve_hashes'; // simulation store of hashes

function getHist() {
  return JSON.parse(localStorage.getItem(HIST_KEY) || '[]');
}

/* ---------- Render table ---------- */
function renderReleve(list) {
  const tbody = document.getElementById("releveTable");
  tbody.innerHTML = "";
  if (!list.length) {
    tbody.innerHTML = "<tr><td colspan='7' style='text-align:center;padding:1rem;'>Aucune transaction trouv√©e</td></tr>";
    return;
  }
  list.forEach(tx => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td style="padding:8px;">${tx.date || '-'}</td>
      <td>${tx.type || '-'}</td>
      <td>${tx.amount || '0'}</td>
      <td>${tx.method || '-'}</td>
      <td>${tx.to || tx.from || '-'}</td>
      <td>${tx.motif || '-'}</td>
      <td>${tx.status || '-'}</td>
    `;
    tbody.appendChild(tr);
  });
}

/* ---------- Filters ---------- */
function filterTransactions() {
  const start = document.getElementById("startDate").value;
  const end = document.getElementById("endDate").value;
  let hist = getHist();
  if (start) hist = hist.filter(tx => new Date(tx.date) >= new Date(start));
  if (end) hist = hist.filter(tx => new Date(tx.date) <= new Date(end));
  renderReleve(hist);
}

function resetFilter() {
  document.getElementById("startDate").value = "";
  document.getElementById("endDate").value = "";
  renderReleve(getHist());
}

/* ---------- Hash util ---------- */
async function sha256Hex(str) {
  const enc = new TextEncoder();
  const data = enc.encode(str);
  const hashBuf = await crypto.subtle.digest('SHA-256', data);
  return Array.from(new Uint8Array(hashBuf)).map(b => b.toString(16).padStart(2, '0')).join('');
}

/* ---------- PDF export + QR + stamp/signature ---------- */
async function downloadPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p', 'pt', 'a4');
  const hist = getHist();

  // canonical string for hashing
  const canonical = JSON.stringify(hist.map(tx => ({
    date: tx.date, type: tx.type, amount: tx.amount, method: tx.method, name: tx.to || tx.from, motif: tx.motif, status: tx.status
  })));
  const hash = await sha256Hex(canonical);

  // Save hash to localStorage (simulation of server-side registry)
  const known = JSON.parse(localStorage.getItem(HASH_STORE_KEY) || '[]');
  known.push({ hash, createdAt: Date.now(), count: hist.length });
  localStorage.setItem(HASH_STORE_KEY, JSON.stringify(known));

  // Header
  doc.setFontSize(16);
  doc.setTextColor(40);
  doc.text("KwikSend ‚Äî Relev√© de transactions", 40, 48);
  doc.setFontSize(10);
  doc.text(`Nom : KwikSend User`, 40, 66);
  doc.text(`Email : user@kwiksend.com`, 40, 80);
  doc.text(`P√©riode : 01/09/2025 - 04/10/2025`, 40, 94);

  // Table rows
  const rows = hist.map(tx => [
    tx.date || '-', tx.type || '-', tx.amount || '0', tx.method || '-', tx.to || tx.from || '-', tx.motif || '-', tx.status || '-'
  ]);

  doc.autoTable({
    head: [['Date', 'Type', 'Montant (‚Ç¨)', 'Moyen', 'De / √Ä', 'Motif', 'Statut']],
    body: rows,
    startY: 120,
    styles: { fontSize: 9, cellPadding: 3 },
    headStyles: { fillColor: [255, 122, 0] }
  });

  // Attempt to add stamp.png and signature.png if exist (place at bottom-right)
  try {
    // helper: fetch as dataURL
    const fileToDataUrl = async (url) => {
      const r = await fetch(url);
      if (!r.ok) throw new Error('no file');
      const blob = await r.blob();
      return await new Promise(res => {
        const fr = new FileReader();
        fr.onload = () => res(fr.result);
        fr.readAsDataURL(blob);
      });
    };

    const pageH = doc.internal.pageSize.getHeight();
    const pageW = doc.internal.pageSize.getWidth();

    // stamp
    const stampUrl = await fileToDataUrl('stamp.png').catch(()=>null);
    if (stampUrl) {
      const stampW = 110, stampH = 110;
      doc.addImage(stampUrl, 'PNG', pageW - stampW - 40, pageH - stampH - 80, stampW, stampH);
    }

    // signature
    const signUrl = await fileToDataUrl('signature.png').catch(()=>null);
    if (signUrl) {
      const sigW = 140, sigH = 50;
      doc.addImage(signUrl, 'PNG', pageW - sigW - 40, pageH - sigH - 200, sigW, sigH);
    }
  } catch (e) {
    // ignore missing images
    console.warn('Stamp/sign not added:', e);
  }

  // QR pointing to verify page with hash
  const verifyUrl = `${location.origin}/verify_releve.html?h=${hash}`;
  const qrDataUrl = await QRCode.toDataURL(verifyUrl, { margin: 1, width: 120 });

  const lastY = doc.lastAutoTable ? doc.lastAutoTable.finalY : 140;
  doc.addImage(qrDataUrl, 'PNG', 40, lastY + 20, 90, 90);
  doc.setFontSize(8);
  doc.text(`V√©rifier : ${verifyUrl}`, 140, lastY + 40, { maxWidth: 340 });

  // Put the short hash and full hash (small) at bottom
  doc.setFontSize(8);
  doc.text(`SHA256: ${hash}`, 40, doc.internal.pageSize.getHeight() - 30);

  // Save PDF
  doc.save("KwikSend_Releve.pdf");
}

/* ---------- Logout ---------- */
function logout() {
  localStorage.removeItem("kwiksend_user");
  window.location.href = "index.html";
}

/* ---------- Init ---------- */
document.addEventListener("DOMContentLoaded", () => {
  renderReleve(getHist());
});
</script>
<!-- Appels scripts globaux -->
<script src="app.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
(async function(){
  const { jsPDF } = window.jspdf;

  document.getElementById("downloadPDF").addEventListener("click", () => {
    const doc = new jsPDF();
    const dateNow = new Date().toLocaleDateString('fr-FR');

    // En-t√™te
    doc.setFont("helvetica", "bold");
    doc.setFontSize(18);
    doc.text("Relev√© officiel de transactions", 20, 20);
    doc.setFontSize(11);
    doc.setFont("helvetica", "normal");
    doc.text(`Nom du titulaire : ${localStorage.getItem("kwiksend_user") || "Utilisateur KwikSend"}`, 20, 30);
    doc.text(`Date d'√©mission : ${dateNow}`, 20, 36);
    doc.line(20, 40, 190, 40);

    // Donn√©es de simulation
    const data = JSON.parse(localStorage.getItem("ks_history") || "[]");
    let y = 50;

    if (data.length === 0) {
      doc.text("Aucune transaction enregistr√©e.", 20, y);
    } else {
      doc.setFont("helvetica", "bold");
      doc.text("Type", 20, y);
      doc.text("Montant (‚Ç¨)", 60, y);
      doc.text("Moyen", 100, y);
      doc.text("Date", 140, y);
      doc.text("Motif", 170, y, { align: "right" });
      y += 6;
      doc.setFont("helvetica", "normal");

      data.forEach(tx => {
        doc.text(tx.type || "-", 20, y);
        doc.text(String(tx.amount || "-"), 60, y);
        doc.text(tx.method || "-", 100, y);
        doc.text(tx.date || "-", 140, y);
        doc.text(tx.motif || "-", 190, y, { align: "right" });
        y += 6;
      });
    }

    // Tampon officiel uniquement
const stamp = new Image();
stamp.src = "stamp.png";

stamp.onload = () => {
  doc.addImage(stamp, "PNG", 20, 250, 40, 40); // position et taille du tampon
  doc.setFontSize(10);
  doc.text("Tampon officiel KwikSend", 20, 295);
  doc.save("Releve_KwikSend.pdf");
};
    };
  });
})();
</script>
</body>
</html>