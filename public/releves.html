<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KwikSend ‚Äî Relev√©s</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="manifest" href="site.webmanifest">
  
  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">

  <!-- Librairies -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', -apple-system, sans-serif;
    }

    @keyframes bgGradient {
      0% { background: linear-gradient(135deg, #ffffff 0%, #fff8f2 100%); }
      33% { background: linear-gradient(135deg, #fff8f2 0%, #ffe7cc 100%); }
      66% { background: linear-gradient(135deg, #ffe7cc 0%, #f3e5f5 100%); }
      100% { background: linear-gradient(135deg, #f3e5f5 0%, #ffffff 100%); }
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    body {
      background: #ffffff;
      animation: bgGradient 12s ease-in-out infinite;
      color: #0A0F1C;
      min-height: 100vh;
    }

    /* üß≠ Header moderne */
    header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 1rem 0;
      border-bottom: 1px solid rgba(255, 138, 0, 0.1);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      position: sticky;
      top: 0;
      z-index: 999;
    }

    .header-container {
      width: 90%;
      max-width: 1200px;
      margin: auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      font-size: 1.5rem;
      font-weight: 900;
      background: linear-gradient(90deg, #FF8A00, #00B87C);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      cursor: pointer;
    }

    .nav-links {
      display: flex;
      gap: 2rem;
      list-style: none;
    }

    .nav-links a {
      color: #0A0F1C;
      text-decoration: none;
      font-weight: 500;
      transition: 0.2s;
    }

    .nav-links a:hover, .nav-links a.active {
      color: #FF8A00;
    }

    .burger {
      display: none;
      font-size: 2rem;
      cursor: pointer;
      color: #FF8A00;
    }

    /* üìä Container principal */
    .releves-container {
      max-width: 1100px;
      margin: 3rem auto;
      padding: 0 1rem;
    }

    .page-title {
      text-align: center;
      font-size: 2rem;
      font-weight: 900;
      margin-bottom: 2rem;
      background: linear-gradient(90deg, #FF8A00, #00B87C, #8B5CF6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: slideDown 0.6s ease;
    }

    /* üë§ Info utilisateur */
    .user-info-card {
      background: white;
      padding: 2rem;
      border-radius: 20px;
      box-shadow: 0 6px 20px rgba(10, 15, 28, 0.08);
      border: 1px solid rgba(255, 138, 0, 0.1);
      margin-bottom: 2rem;
      animation: slideDown 0.6s ease 0.1s both;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }

    .info-item {
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
    }

    .info-label {
      font-size: 0.85rem;
      color: #666;
      font-weight: 500;
    }

    .info-value {
      font-size: 1rem;
      font-weight: 700;
      color: #0A0F1C;
    }

    /* üîç Filtres */
    .filters-card {
      background: white;
      padding: 1.5rem;
      border-radius: 20px;
      box-shadow: 0 6px 20px rgba(10, 15, 28, 0.08);
      border: 1px solid rgba(255, 138, 0, 0.1);
      margin-bottom: 2rem;
      animation: slideDown 0.6s ease 0.2s both;
    }

    .filters-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
    }

    .filter-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .filter-group label {
      font-weight: 600;
      color: #0A0F1C;
      font-size: 0.9rem;
    }

    .filter-group input[type="date"] {
      padding: 0.6rem 1rem;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 0.9rem;
      transition: all 0.3s;
      background: white;
      color: #0A0F1C;
    }

    .filter-group input[type="date"]:focus {
      outline: none;
      border-color: #FF8A00;
      box-shadow: 0 0 0 4px rgba(255, 138, 0, 0.1);
    }

    .btn {
      padding: 0.7rem 1.5rem;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-primary {
      background: linear-gradient(135deg, #FF8A00, #FFA500);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(255, 138, 0, 0.3);
    }

    .btn-secondary {
      background: #f0f0f0;
      color: #666;
    }

    .btn-secondary:hover {
      background: #e0e0e0;
    }

    .btn-success {
      background: linear-gradient(135deg, #00B87C, #00D48F);
      color: white;
      margin-left: auto;
    }

    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0, 184, 124, 0.3);
    }

    /* üìã Tableau */
    .table-container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 6px 20px rgba(10, 15, 28, 0.08);
      border: 1px solid rgba(255, 138, 0, 0.1);
      overflow: hidden;
      animation: slideDown 0.6s ease 0.3s both;
    }

    .table-wrapper {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: linear-gradient(135deg, #FF8A00, #FFA500);
      color: white;
    }

    thead th {
      padding: 1rem;
      text-align: left;
      font-weight: 700;
      font-size: 0.9rem;
      letter-spacing: 0.5px;
    }

    tbody tr {
      border-bottom: 1px solid rgba(255, 138, 0, 0.1);
      transition: all 0.2s;
    }

    tbody tr:hover {
      background: rgba(255, 138, 0, 0.05);
    }

    tbody td {
      padding: 1rem;
      font-size: 0.9rem;
      color: #0A0F1C;
    }

    tbody tr:last-child {
      border-bottom: none;
    }

    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: #666;
    }

    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    /* üí° Note */
    .info-note {
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.08), rgba(255, 138, 0, 0.08));
      border-left: 4px solid #8B5CF6;
      padding: 1rem 1.5rem;
      border-radius: 12px;
      margin-top: 2rem;
      font-size: 0.9rem;
      color: #666;
      text-align: center;
      animation: slideDown 0.6s ease 0.4s both;
    }

    /* Footer */
    footer {
      background: #0A0F1C;
      color: white;
      text-align: center;
      padding: 2rem;
      margin-top: 3rem;
    }

    /* üì± Responsive */
    @media (max-width: 768px) {
      .nav-links {
        display: none;
        position: absolute;
        top: 60px;
        right: 10px;
        background: white;
        flex-direction: column;
        padding: 1rem;
        border-radius: 10px;
        width: 200px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
      }

      .nav-links.active {
        display: flex;
      }

      .burger {
        display: block;
      }

      .page-title {
        font-size: 1.5rem;
      }

      .info-grid {
        grid-template-columns: 1fr;
      }

      .filters-grid {
        flex-direction: column;
        align-items: stretch;
      }

      .filter-group {
        flex-direction: column;
        align-items: stretch;
      }

      .btn-success {
        margin-left: 0;
      }

      thead th,
      tbody td {
        padding: 0.6rem;
        font-size: 0.85rem;
      }

      thead th:nth-child(4),
      tbody td:nth-child(4),
      thead th:nth-child(6),
      tbody td:nth-child(6) {
        display: none;
      }
    }

    /* Loader animation */
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loader {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 4px solid rgba(255, 138, 0, 0.2);
      border-top-color: #FF8A00;
      animation: spin 0.8s linear infinite;
      margin: 2rem auto;
    }
  </style>
</head>
<body>

<!-- üß≠ Header -->
<header>
  <div class="header-container">
    <div class="logo" onclick="window.location.href='dashboard.html'">KwikSend</div>
    <nav>
      <ul class="nav-links" id="nav-menu">
        <li><a href="dashboard.html">Accueil</a></li>
        <li><a href="portefeuille.html">Portefeuille</a></li>
        <li><a href="transfert.html">Transfert</a></li>
        <li><a href="kwiktransfert.html">KwikTransfert</a></li>
        <li><a href="releves.html" class="active">Relev√©s</a></li>
        <li><a href="profile.html">Compte</a></li>
        <li><a href="#" onclick="logout()">D√©connexion</a></li>
      </ul>
    </nav>
    <span class="burger" onclick="toggleMenu()">‚ò∞</span>
  </div>
</header>

<!-- üìä Container principal -->
<div class="releves-container">
  
  <h1 class="page-title">üìÑ Relev√© de transactions</h1>

  <!-- üë§ Info utilisateur -->
  <div class="user-info-card">
    <div class="info-grid">
      <div class="info-item">
        <span class="info-label">üë§ Nom</span>
        <span class="info-value" id="userName">KwikSend User</span>
      </div>
      <div class="info-item">
        <span class="info-label">üìß Email</span>
        <span class="info-value" id="userEmail">user@kwiksend.com</span>
      </div>
      <div class="info-item">
        <span class="info-label">üìÖ P√©riode</span>
        <span class="info-value" id="period">01/09/2025 ‚Äì 04/11/2025</span>
      </div>
      <div class="info-item">
        <span class="info-label">üí∞ Devise principale</span>
        <span class="info-value">EUR (‚Ç¨)</span>
      </div>
    </div>
  </div>

  <!-- üîç Filtres -->
  <div class="filters-card">
    <div class="filters-grid">
      <div class="filter-group">
        <label>Du :</label>
        <input type="date" id="startDate" />
      </div>
      
      <div class="filter-group">
        <label>au :</label>
        <input type="date" id="endDate" />
      </div>
      
      <button class="btn btn-primary" onclick="filterTransactions()">üîç Appliquer</button>
      <button class="btn btn-secondary" onclick="resetFilter()">üîÑ R√©initialiser</button>
      <button class="btn btn-success" id="downloadPDF">üì• T√©l√©charger PDF</button>
    </div>
  </div>

  <!-- üìã Tableau -->
  <div class="table-container">
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>üìÖ Date</th>
            <th>üìù Type</th>
            <th>üí∞ Montant (‚Ç¨)</th>
            <th>üí≥ Moyen</th>
            <th>üë§ De / √Ä</th>
            <th>üìå Motif</th>
            <th>‚úÖ Statut</th>
          </tr>
        </thead>
        <tbody id="releveTable">
          <!-- Rempli par JavaScript -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- üí° Note -->
  <div class="info-note">
    <strong>‚ÑπÔ∏è Note :</strong> Ce relev√© est g√©n√©r√© automatiquement par KwikSend. 
    Les donn√©es affich√©es sont issues de votre historique de transactions. 
    Le PDF t√©l√©charg√© inclut un QR code de v√©rification et un hash SHA-256 pour authentification.
  </div>

</div>

<!-- Footer -->
<footer>
  <p>¬© 2025 KwikSend. Tous droits r√©serv√©s.</p>
</footer>

<!-- üìú Scripts -->
<script>
/* ========================================
   üéÆ CONFIGURATION & HELPERS
======================================== */
const HIST_KEY = 'ks_history';
const HASH_STORE_KEY = 'ks_releve_hashes';

function getHist() {
  return JSON.parse(localStorage.getItem(HIST_KEY) || '[]');
}

/* ========================================
   üìä RENDER TABLE
======================================== */
function renderReleve(list) {
  const tbody = document.getElementById("releveTable");
  tbody.innerHTML = "";
  
  if (!list.length) {
    tbody.innerHTML = `
      <tr>
        <td colspan="7" class="empty-state">
          <div class="empty-state-icon">üì≠</div>
          <div>Aucune transaction trouv√©e</div>
        </td>
      </tr>
    `;
    return;
  }
  
  list.forEach(tx => {
    const tr = document.createElement("tr");
    
    // Format montant avec couleur
    const amount = parseFloat(tx.amount) || 0;
    const amountClass = amount >= 0 ? 'amount-positive' : 'amount-negative';
    const amountDisplay = amount >= 0 ? `+${amount}` : amount;
    
    // Format statut avec badge
    const statusClass = tx.status === 'R√©ussi' ? '‚úÖ' : 
                       tx.status === 'En cours' ? '‚è≥' : 
                       tx.status === 'En attente' ? '‚è≥' : '‚ùì';
    
    tr.innerHTML = `
      <td>${tx.date || '-'}</td>
      <td><strong>${tx.type || '-'}</strong></td>
      <td style="font-weight:700;color:${amount >= 0 ? '#00B87C' : '#FF8A00'}">${amountDisplay} ‚Ç¨</td>
      <td>${tx.method || '-'}</td>
      <td>${tx.to || tx.from || '-'}</td>
      <td>${tx.motif || '-'}</td>
      <td>${statusClass} ${tx.status || '-'}</td>
    `;
    
    tbody.appendChild(tr);
  });
}

/* ========================================
   üîç FILTERS
======================================== */
function filterTransactions() {
  const start = document.getElementById("startDate").value;
  const end = document.getElementById("endDate").value;
  
  let hist = getHist();
  
  if (start) {
    hist = hist.filter(tx => {
      const txDate = new Date(tx.date);
      return txDate >= new Date(start);
    });
  }
  
  if (end) {
    hist = hist.filter(tx => {
      const txDate = new Date(tx.date);
      return txDate <= new Date(end);
    });
  }
  
  renderReleve(hist);
}

function resetFilter() {
  document.getElementById("startDate").value = "";
  document.getElementById("endDate").value = "";
  renderReleve(getHist());
}

/* ========================================
   üîê HASH UTILITY
======================================== */
async function sha256Hex(str) {
  const enc = new TextEncoder();
  const data = enc.encode(str);
  const hashBuf = await crypto.subtle.digest('SHA-256', data);
  return Array.from(new Uint8Array(hashBuf))
    .map(b => b.toString(16).padStart(2, '0'))
    .join('');
}

/* ========================================
   üì• PDF EXPORT
======================================== */
async function downloadPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p', 'pt', 'a4');
  const hist = getHist();

  // G√©n√©ration hash
  const canonical = JSON.stringify(hist.map(tx => ({
    date: tx.date, 
    type: tx.type, 
    amount: tx.amount, 
    method: tx.method, 
    name: tx.to || tx.from, 
    motif: tx.motif, 
    status: tx.status
  })));
  
  const hash = await sha256Hex(canonical);

  // Sauvegarde hash
  const known = JSON.parse(localStorage.getItem(HASH_STORE_KEY) || '[]');
  known.push({ 
    hash, 
    createdAt: Date.now(), 
    count: hist.length 
  });
  localStorage.setItem(HASH_STORE_KEY, JSON.stringify(known));

  // En-t√™te PDF
  doc.setFontSize(16);
  doc.setFont(undefined, 'bold');
  doc.text("KwikSend ‚Äî Relev√© de transactions", 40, 48);
  
  doc.setFontSize(10);
  doc.setFont(undefined, 'normal');
  doc.text(`Nom : ${document.getElementById('userName').textContent}`, 40, 66);
  doc.text(`Email : ${document.getElementById('userEmail').textContent}`, 40, 80);
  doc.text(`P√©riode : ${document.getElementById('period').textContent}`, 40, 94);

  // Tableau
  const rows = hist.map(tx => [
    tx.date || '-', 
    tx.type || '-', 
    tx.amount || '0', 
    tx.method || '-', 
    tx.to || tx.from || '-', 
    tx.motif || '-', 
    tx.status || '-'
  ]);

  doc.autoTable({
    head: [['Date', 'Type', 'Montant (‚Ç¨)', 'Moyen', 'De / √Ä', 'Motif', 'Statut']],
    body: rows,
    startY: 120,
    styles: { 
      fontSize: 9, 
      cellPadding: 3 
    },
    headStyles: { 
      fillColor: [255, 138, 0],
      fontStyle: 'bold'
    }
  });

  // QR Code de v√©rification
  const verifyUrl = `${location.origin}/verify_releve.html?h=${hash}`;
  const qrDataUrl = await QRCode.toDataURL(verifyUrl, { 
    margin: 1, 
    width: 120 
  });
  
  const lastY = doc.lastAutoTable ? doc.lastAutoTable.finalY : 140;
  doc.addImage(qrDataUrl, 'PNG', 40, lastY + 20, 90, 90);
  
  doc.setFontSize(8);
  doc.text(`V√©rifier l'authenticit√© : ${verifyUrl}`, 140, lastY + 40, { 
    maxWidth: 340 
  });

  // Hash SHA-256
  doc.setFontSize(7);
  doc.text(`SHA256: ${hash}`, 40, doc.internal.pageSize.getHeight() - 30);

  // T√©l√©chargement
  doc.save("KwikSend_Releve.pdf");
  
  // Notification
  showNotification('‚úÖ Relev√© PDF t√©l√©charg√© avec succ√®s !');
}

/* ========================================
   üí¨ NOTIFICATION
======================================== */
function showNotification(message) {
  const toast = document.createElement('div');
  toast.textContent = message;
  toast.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: linear-gradient(90deg, #FF8A00, #00B87C);
    color: white;
    padding: 1rem 2rem;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(255, 138, 0, 0.4);
    z-index: 99999;
    font-weight: 600;
    animation: slideDown 0.4s ease;
  `;
  
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.animation = 'slideOut 0.4s ease';
    setTimeout(() => toast.remove(), 400);
  }, 3000);
}

/* ========================================
   üö™ LOGOUT
======================================== */
function logout() {
  localStorage.removeItem("kwiksend_user");
  window.location.href = "index.html";
}

/* ========================================
   üçî TOGGLE MENU
======================================== */
function toggleMenu() {
  document.getElementById("nav-menu").classList.toggle("active");
}

/* ========================================
   üîÑ INIT
======================================== */
document.addEventListener("DOMContentLoaded", () => {
  // Chargement des donn√©es utilisateur
  const user = JSON.parse(localStorage.getItem("kwiksend_user") || "{}");
  if (user.name) {
    document.getElementById("userName").textContent = user.name;
  }
  if (user.email) {
    document.getElementById("userEmail").textContent = user.email;
  }
  
  // P√©riode dynamique (30 derniers jours)
  const today = new Date();
  const thirtyDaysAgo = new Date(today);
  thirtyDaysAgo.setDate(today.getDate() - 30);
  
  const formatDate = (date) => {
    return date.toLocaleDateString('fr-FR', { 
      day: '2-digit', 
      month: '2-digit', 
      year: 'numeric' 
    });
  };
  
  document.getElementById("period").textContent = 
    `${formatDate(thirtyDaysAgo)} ‚Äì ${formatDate(today)}`;
  
  // Render transactions
  renderReleve(getHist());
  
  // Event listener PDF
  document.getElementById("downloadPDF").addEventListener("click", downloadPDF);
});
</script>

<!-- Appel scripts globaux -->
<script src="app.js"></script>

</body>
</html>
