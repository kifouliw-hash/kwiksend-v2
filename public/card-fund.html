<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KwikSend â€” Alimenter par carte</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header><div class="logo">Kwik<span>Send</span></div></header>

  <main style="max-width:680px;margin:40px auto;padding:20px;text-align:center;">
    <h1>ğŸ’³ Alimenter â€” Carte bancaire (simulation)</h1>
    <p>Entrez des infos fictives et le montant pour simuler lâ€™alimentation.</p>

    <form id="fundForm" style="margin-top:18px;display:flex;flex-direction:column;gap:10px;">
      <input id="cardNumber" type="text" placeholder="NumÃ©ro de carte (fake)" required />
      <input id="cardExpiry" type="text" placeholder="MM/AA" required />
      <input id="cardCvv" type="text" placeholder="CVV" required />
      <input id="amount" type="number" placeholder="Montant (â‚¬)" min="0.1" step="0.01" required />
      <button type="submit" class="btn btn-accent">Valider (simulation)</button>
    </form>

    <p id="msg" style="color:green;margin-top:12px"></p>
    <p style="margin-top:18px"><a href="portefeuille.html">â† Retour au portefeuille</a></p>
  </main>

<script>
(() => {
  const BAL_KEY='ks_balance', HIST_KEY='ks_history';

  const getBal = () => parseFloat(localStorage.getItem(BAL_KEY) || '0');
  const setBal = v => localStorage.setItem(BAL_KEY, String(v));
  const getHist = () => JSON.parse(localStorage.getItem(HIST_KEY) || '[]');
  const setHist = a => localStorage.setItem(HIST_KEY, JSON.stringify(a));

  // basic Luhn check (optional but useful)
  function luhnCheck(num){
    const s = String(num).replace(/\D/g,'').split('').reverse().map(Number);
    let sum = 0;
    for (let i=0;i<s.length;i++){
      let v = s[i];
      if(i % 2 === 1){ v *= 2; if(v>9) v -= 9; }
      sum += v;
    }
    return sum % 10 === 0;
  }

  const form = document.getElementById('fundForm');
  form.addEventListener('submit',(e)=>{
    e.preventDefault();
    const amount = parseFloat(document.getElementById('amount').value);
    const card = document.getElementById('cardNumber').value.trim();
    const exp = document.getElementById('cardExpiry').value.trim();
    const cvv = document.getElementById('cardCvv').value.trim();

    if(!(amount>0)) return alert('Montant invalide');
    if(card.length < 12 || !luhnCheck(card)) {
      if(!confirm("NumÃ©ro de carte invalide (simulation). Continuer quand mÃªme ?")) return;
    }

    // save temp pending payment then redirect to 3DS simulation
    sessionStorage.setItem('ks_pending', JSON.stringify({
      type: 'Alimentation (Carte)',
      amount: amount,
      method: 'Carte',
      ts: Date.now()
    }));
    window.location.href = `3ds.html?return=${encodeURIComponent('card-fund.html')}`;
  });

  // finalize if returned from 3DS
  const params = new URLSearchParams(location.search);
  if(params.get('3ds') === 'ok' && sessionStorage.getItem('ks_pending')){
    const pending = JSON.parse(sessionStorage.getItem('ks_pending'));
    const newBal = getBal() + Number(pending.amount);
    setBal(newBal);
    const hist = getHist();
    hist.unshift({ date: new Date().toLocaleString(), type: pending.type, amount: (Number(pending.amount)).toFixed(2), method: pending.method, status: 'RÃ©ussi' });
    setHist(hist);
    sessionStorage.removeItem('ks_pending');
    document.getElementById('msg').textContent = 'âœ… Paiement validÃ© (3DS). Redirection...';
    setTimeout(()=> window.location.href = 'portefeuille.html?ok=1', 900);
  }
})();
</script>
</body>
</html>